{% extends "layout.html" %} {% block content %}
<h1 class="mb-1">Data Structure: Hashes</h1>
<p class="lead text-info">Use Case: Storing Domain Metadata as an Object</p>
<hr class="my-4" />

<div class="row g-4">
  <div class="col-md-6">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-body">
        <h5 class="card-title">Live Demo: Domain Metadata</h5>
        <p class="card-text">
          Go to the "Home" page and query a domain (e.g., `google.com`) a few
          times. Then, look it up here to see its metadata.
        </p>

        <form method="POST" action="/feature/hashes">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              name="domain"
              placeholder="e.g., google.com"
              value="{{ domain or '' }}"
              required
            />
            <button class="btn btn-primary" type="submit">Get Metadata</button>
          </div>
        </form>

        {% if domain %}
        <h6 class="mt-4">
          Metadata for: <code class="text-info">{{ hash_key }}</code>
        </h6>
        {% if metadata %}
        <table class="table table-dark table-striped-columns mt-3">
          <thead>
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            {% for field, value in metadata.items() %}
            <tr>
              <td><code>{{ field }}</code></td>
              <td><code>{{ value }}</code></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-secondary mt-3">
          No metadata found. Go query this domain on the Home page first!
        </p>
        {% endif %} {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-body">
        <h5 class="card-title">Why Use a Redis Hash?</h5>
        <p>
          A <strong>Hash</strong> is perfect for storing "objects," or any data
          with named fields. This project demonstrates two powerful use cases
          for Hashes:
        </p>

        <ol>
          <li>
            <strong>This Page (Metadata):</strong> We use a Hash
            (<code>dns:meta:...</code>) to store counters and timestamps for a
            domain. Commands like <code>HINCRBY</code> are atomic and
            purpose-built for incrementing a field, making it perfect for
            analytics.
          </li>
          <li>
            <strong>Our Core Cache (Home Page):</strong> We use a Hash
            (<code>dns:cache:...</code>) to store the *result* of a DNS lookup.
            The fields (<code>records</code>, <code>fetched_at</code>) are
            stored together under a single key.
          </li>
        </ol>

        <p>
          The alternative is using multiple String keys (e.g.,
          <code>dns:google.com:hits</code>,
          <code>dns:google.com:last_fetched</code>). A Hash is far more
          memory-efficient and cleaner, as it groups all related data under one
          key.
        </p>

        <h6 class="mt-4">Key Commands for Hashes:</h6>
        <ul class="list-unstyled">
          <li class="mb-2">
            <code class="text-danger">HSET</code> / <code>HSETNX</code>: Sets a
            field's value. Performance: <strong>O(1)</strong>.
          </li>
          <li class="mb-2">
            <code class="text-danger">HGET</code>: Gets a single field's value.
            Performance: <strong>O(1)</strong>.
          </li>
          <li class="mb-2">
            <code class="text-danger">HINCRBY</code>: Atomically increments a
            field's value. Performance: <strong>O(1)</strong>.
          </li>
          <li>
            <code class="text-danger">HGETALL</code>: Gets *all* fields and
            values. Performance: <strong>O(N)</strong>, where N is the number of
            fields (use with caution on large hashes).
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card bg-dark border-secondary">
      <div class="card-body">
        <h5 class="card-title">Technical Deep Dive</h5>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="python-tab"
              data-bs-toggle="tab"
              data-bs-target="#python-tab-pane"
              type="button"
            >
              Python (Flask)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="cli-tab"
              data-bs-toggle="tab"
              data-bs-target="#cli-tab-pane"
              type="button"
            >
              Try it in `redis-cli`
            </button>
          </li>
        </ul>
        <div class="tab-content mt-3" id="myTabContent">
          <div class="tab-pane fade show active" id="python-tab-pane">
            <p>On every DNS lookup, we run these two commands:</p>
            <pre><code class="language-python" style="background: #2b2b2b; color: #f8f8f2; padding: 1em; display: block; border-radius: 5px;">
hash_key = f"dns:meta:{domain_name}"

# 1. Atomically increment the hit counter
r.hincrby(hash_key, 'hit_count', 1)

# 2. Set the last fetched timestamp
current_timestamp = time.strftime('%Y-%m-%d %H:%M:%S UTC', time.gmtime())
r.hset(hash_key, 'last_fetched', current_timestamp)
</code></pre>
            <p>To display the metadata on this page, we run:</p>
            <pre><code class="language-python" style="background: #2b2b2b; color: #f8f8f2; padding: 1em; display: block; border-radius: 5px;">
# Get all fields and values from the hash
metadata = r.hgetall(hash_key)
# metadata is now a dict: {'hit_count': '5', 'last_fetched': '...'}
</code></pre>
          </div>

          <div class="tab-pane fade" id="cli-tab-pane">
            <p>
              Open <code class="text-info">redis-cli</code> and query a domain
              on the Home page. Then try these commands:
            </p>
            <pre><code style="background: #2b2b2b; color: #f8f8f2; padding: 1em; display: block; border-radius: 5px;">
# See all keys in your database (you'll see your "dns:" and "dns:meta:" keys)
KEYS *

# Get all fields and values for the google.com hash
HGETALL "dns:meta:google.com"

# Get just the hit count
HGET "dns:meta:google.com" "hit_count"

# Increment the count yourself and then refresh this page!
HINCRBY "dns:meta:google.com" "hit_count" 10
</code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
